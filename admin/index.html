<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AdjuvantIQ Content Manager</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .auth-container {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .login-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
    }
    .google-btn {
      background: #4285f4;
      color: white;
    }
    .github-btn {
      background: #24292e;
      color: white;
    }
    .user-info {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e8;
      border-radius: 4px;
    }
    .cms-container {
      margin-top: 20px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="auth-container" class="auth-container">
    <h2>AdjuvantIQ CMS</h2>
    <p>Sign in to access the content management system</p>
    
    <div id="loading" class="loading">
      Loading authentication...
    </div>
    
    <div id="login-buttons" style="display: none;">
      <button id="google-login" class="login-btn google-btn">
        Sign in with Google
      </button>
      
      <button id="github-login" class="login-btn github-btn">
        Sign in with GitHub
      </button>
    </div>
    
    <div id="user-info" class="user-info" style="display: none;">
      <p>Welcome, <span id="user-name"></span>!</p>
      <p>Email: <span id="user-email"></span></p>
      <button id="logout-btn" class="login-btn" style="background: #dc3545; color: white;">
        Sign Out
      </button>
    </div>
  </div>

  <div id="cms-container" class="cms-container" style="display: none;">
    <!-- Netlify CMS will be loaded here -->
  </div>

  <!-- Auth0 Lock Widget -->
  <script src="https://cdn.auth0.com/js/lock/11.30/lock.min.js"></script>
  
  <!-- Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  
  <script>
    // Initialize Auth0 configuration after loading environment variables
    async function initializeAuth0() {
      try {
        // Fetch environment variables from Netlify function
        const response = await fetch('/.netlify/functions/get-auth-config');
        const config = await response.json();
        
        if (!config.clientId || !config.domain) {
          throw new Error('Auth0 configuration not found');
        }
        
        // Initialize Auth0 Lock
        const lock = new Auth0Lock(
          config.clientId,
          config.domain,
          {
            auth: {
              redirectUrl: window.location.origin + '/admin',
              responseType: 'token id_token',
              params: {
                scope: 'openid profile email'
              }
            },
            socialButtonStyle: 'big',
            theme: {
              logo: 'https://adjuvantiq.com/assets/images/logos/AdjuvantIQ_Logo_teal_trans.svg',
              primaryColor: '#4285f4'
            },
            languageDictionary: {
              title: 'AdjuvantIQ CMS'
            },
            allowSignUp: false,
            allowForgotPassword: false,
            closable: false,
            social: {
              google: {
                connection: 'google-oauth2'
              },
              github: {
                connection: 'github'
              }
            }
          }
        );
        
        // Setup UI elements
        setupUI(lock);
        
      } catch (error) {
        console.error('Failed to initialize Auth0:', error);
        document.getElementById('loading').innerHTML = 'Authentication service unavailable. Please try again later.';
      }
    }
    
    function setupUI(lock) {
      // DOM elements
      const authContainer = document.getElementById('auth-container');
      const userInfo = document.getElementById('user-info');
      const userName = document.getElementById('user-name');
      const userEmail = document.getElementById('user-email');
      const cmsContainer = document.getElementById('cms-container');
      const loginButtons = document.getElementById('login-buttons');
      const loading = document.getElementById('loading');
      const googleBtn = document.getElementById('google-login');
      const githubBtn = document.getElementById('github-login');
      const logoutBtn = document.getElementById('logout-btn');
      
      // Show login buttons
      loading.style.display = 'none';
      loginButtons.style.display = 'block';
      
      // Check if user is already authenticated
      function checkAuth() {
        const token = localStorage.getItem('auth0_token');
        const user = JSON.parse(localStorage.getItem('auth0_user') || 'null');
        
        if (token && user) {
          showUserInfo(user);
          initializeCMS();
        }
      }
      
      // Show user information
      function showUserInfo(user) {
        userName.textContent = user.name || user.email;
        userEmail.textContent = user.email;
        userInfo.style.display = 'block';
        cmsContainer.style.display = 'block';
        loginButtons.style.display = 'none';
      }
      
      // Initialize Netlify CMS
      function initializeCMS() {
        const cmsScript = document.createElement('script');
        cmsScript.src = 'https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js';
        cmsContainer.appendChild(cmsScript);
      }
      
      // Handle authentication
      lock.on('authenticated', function(authResult) {
        lock.getUserInfo(authResult.accessToken, function(error, user) {
          if (error) {
            console.error('Error getting user info:', error);
            return;
          }
          
          localStorage.setItem('auth0_token', authResult.accessToken);
          localStorage.setItem('auth0_user', JSON.stringify(user));
          
          showUserInfo(user);
          initializeCMS();
        });
      });
      
      // Handle logout
      logoutBtn.addEventListener('click', function() {
        localStorage.removeItem('auth0_token');
        localStorage.removeItem('auth0_user');
        window.location.reload();
      });
      
      // Google login
      googleBtn.addEventListener('click', function() {
        lock.show({
          connection: 'google-oauth2'
        });
      });
      
      // GitHub login
      githubBtn.addEventListener('click', function() {
        lock.show({
          connection: 'github'
        });
      });
      
      // Check authentication on page load
      checkAuth();
    }
    
    // Initialize when page loads
    initializeAuth0();
  </script>
</body>
</html>